# ============================================
# ğŸš€ PIPELINE COMPLETA - MOTO MONITORAMENTO (CI + CD)
# ============================================

trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

stages:
  # ========================================
  # ğŸ§± CI - Build + Testes + Artefatos
  # ========================================
  - stage: CI
    displayName: "IntegraÃ§Ã£o ContÃ­nua (Build + Testes)"
    jobs:
      - job: BuildAndTest
        displayName: "Build e Testes AutomÃ¡ticos"
        steps:
          - checkout: self
            displayName: 'ğŸ“¦ Checkout do repositÃ³rio'

          # 1ï¸âƒ£ Instalar SDK do .NET 9
          - task: UseDotNet@2
            inputs:
              packageType: 'sdk'
              version: '9.0.x'
            displayName: 'ğŸ”§ Instalar .NET 9 SDK'

          # 2ï¸âƒ£ Instalar Docker
          - task: DockerInstaller@0
            displayName: 'ğŸ³ Instalar Docker'

          # 3ï¸âƒ£ Restaurar dependÃªncias
          - script: |
              echo "ğŸ“¦ Restaurando dependÃªncias..."
              dotnet restore MotoMonitoramento.sln
            displayName: 'ğŸ“¦ Restaurar dependÃªncias'

          # 4ï¸âƒ£ Compilar aplicaÃ§Ã£o
          - script: |
              echo "ğŸ—ï¸ Compilando aplicaÃ§Ã£o..."
              dotnet build MotoMonitoramento.sln --configuration $(buildConfiguration) --no-restore
            displayName: 'âš™ï¸ Compilar aplicaÃ§Ã£o'

          # 5ï¸âƒ£ Executar testes unitÃ¡rios e integraÃ§Ã£o
          - script: |
              echo "ğŸ§ª Executando testes automatizados..."
              dotnet test tests/MotoMonitoramento.Tests.Unit/MotoMonitoramento.Tests.Unit.csproj --no-build --logger trx --results-directory $(Build.ArtifactStagingDirectory)/TestResults
              dotnet test tests/MotoMonitoramento.Tests.Integration/MotoMonitoramento.Tests.Integration.csproj --no-build --logger trx --results-directory $(Build.ArtifactStagingDirectory)/TestResults
            displayName: 'ğŸ§ª Testes UnitÃ¡rios e IntegraÃ§Ã£o'

          # 6ï¸âƒ£ Publicar artefatos (para CD)
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'
            displayName: 'ğŸ“¦ Publicar artefatos'

          # 7ï¸âƒ£ Build e push Docker (API + MySQL)
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'qmove-azure-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸš€ Build e push das imagens para o ACR..."
                chmod +x ./build.sh
                ./build.sh
            displayName: 'ğŸ³ Build e push Docker'

  # ========================================
  # â˜ï¸ CD - Deploy automÃ¡tico no Azure
  # ========================================
  - stage: CD
    displayName: "Entrega ContÃ­nua (Deploy no Azure)"
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: "ğŸš€ Executar Deploy no Azure"
        steps:
          - checkout: self
            displayName: 'ğŸ“¦ Checkout do repositÃ³rio'

          # Executar deploy via script
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'qmove-azure-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "â˜ï¸ Executando deploy no Azure..."
                chmod +x ./deploy.sh
                ./deploy.sh
            displayName: 'â˜ï¸ Deploy via Azure CLI'
