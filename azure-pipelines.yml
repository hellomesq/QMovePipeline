# ========================================
# ğŸ§± CI - Build + Testes + Artefatos
# ========================================
- stage: CI
  displayName: "IntegraÃ§Ã£o ContÃ­nua (Build + Testes)"
  jobs:
    - job: BuildAndTest
      displayName: "Build e Testes AutomÃ¡ticos"
      steps:
        - checkout: self
          displayName: "ğŸ“¦ Checkout do repositÃ³rio"

        # Instalar .NET 9 SDK
        - task: UseDotNet@2
          inputs:
            packageType: "sdk"
            version: "9.0.x"
          displayName: "ğŸ”§ Instalar .NET 9 SDK"

        # Instalar Docker
        - task: DockerInstaller@0
          displayName: "ğŸ³ Instalar Docker"

        # Restaurar dependÃªncias
        - script: |
            echo "ğŸ“¦ Restaurando dependÃªncias..."
            dotnet restore MotoMonitoramento.sln
          displayName: "ğŸ“¦ Restaurar dependÃªncias"

        # Compilar aplicaÃ§Ã£o
        - script: |
            echo "ğŸ—ï¸ Compilando aplicaÃ§Ã£o..."
            dotnet build MotoMonitoramento.sln --configuration $(buildConfiguration) --no-restore
          displayName: "âš™ï¸ Compilar aplicaÃ§Ã£o"

        # Criar pastas para artefatos e resultados de teste
        - script: |
            mkdir -p $(Build.ArtifactStagingDirectory)/TestResults
            mkdir -p $(Build.ArtifactStagingDirectory)/App
          displayName: "ğŸ“‚ Preparar diretÃ³rios para artefatos e testes"

        # Executar testes UnitÃ¡rios e de IntegraÃ§Ã£o
        - script: |
            echo "ğŸ§ª Executando testes UnitÃ¡rios..."
            dotnet test tests/MotoMonitoramento.Tests.Unit/MotoMonitoramento.Tests.Unit.csproj \
              --no-build \
              --logger "trx;LogFileName=$(Build.ArtifactStagingDirectory)/TestResults/UnitTests.trx"

            echo "ğŸ§ª Executando testes de IntegraÃ§Ã£o..."
            dotnet test tests/MotoMonitoramento.Tests.Integration/MotoMonitoramento.Tests.Integration.csproj \
              --no-build \
              --logger "trx;LogFileName=$(Build.ArtifactStagingDirectory)/TestResults/IntegrationTests.trx"
          displayName: "ğŸ§ª Executar testes UnitÃ¡rios e IntegraÃ§Ã£o"

        # Publicar resultados de teste
        - task: PublishTestResults@2
          inputs:
            testResultsFormat: "VSTest"
            testResultsFiles: "**/TestResults/*.trx"
            failTaskOnFailedTests: true
          displayName: "ğŸ“Š Publicar resultados dos testes"

        # Copiar arquivos de build para artifact staging
        - script: |
            echo "ğŸ“‚ Copiando build para ArtifactStagingDirectory..."
            cp -r **/bin/$(buildConfiguration)/net9.0/* $(Build.ArtifactStagingDirectory)/App/
          displayName: "ğŸ“‚ Copiar build para artifact"

        # Publicar artefatos
        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: "$(Build.ArtifactStagingDirectory)"
            ArtifactName: "drop"
            publishLocation: "Container"
          displayName: "ğŸ“¦ Publicar artefatos"

        # Build e push Docker
        - task: AzureCLI@2
          inputs:
            azureSubscription: "qmove-azure-connection"
            scriptType: "bash"
            scriptLocation: "inlineScript"
            inlineScript: |
              echo "ğŸ³ Build e push das imagens para o ACR..."
              chmod +x ./build.sh
              ./build.sh
          displayName: "ğŸ³ Build e push Docker"
