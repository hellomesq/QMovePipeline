# ============================================
# ğŸš€ PIPELINE DE CI/CD - PROJETO MOTO MONITORAMENTO
# ============================================

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

# =============================
# ğŸ§± ETAPA 1: RESTAURAR E COMPILAR
# =============================
steps:
- task: UseDotNet@2
  displayName: 'ğŸ”§ Configurar versÃ£o do .NET SDK'
  inputs:
    packageType: 'sdk'
    version: '9.0.x'

- script: |
    echo "ğŸ” Restaurando dependÃªncias..."
    dotnet restore MotoMonitoramento.sln
  displayName: 'ğŸ“¦ Restaurar pacotes NuGet'

- script: |
    echo "ğŸ—ï¸ Compilando soluÃ§Ã£o..."
    dotnet build MotoMonitoramento.sln --configuration $(buildConfiguration) --no-restore
  displayName: 'âš™ï¸ Compilar projeto'

# ==============================
# ğŸ§ª TESTES AUTOMATIZADOS
# ==============================
- script: |
    echo "ğŸš€ Executando testes UnitÃ¡rios..."
    dotnet test tests/MotoMonitoramento.Tests.Unit/MotoMonitoramento.Tests.Unit.csproj --no-build --verbosity normal --logger trx
  displayName: 'ğŸ§ª Testes UnitÃ¡rios'
  continueOnError: false

- script: |
    echo "ğŸš€ Executando testes de IntegraÃ§Ã£o..."
    dotnet test tests/MotoMonitoramento.Tests.Integration/MotoMonitoramento.Tests.Integration.csproj --no-build --verbosity normal --logger trx
  displayName: 'ğŸ”¬ Testes de IntegraÃ§Ã£o'
  continueOnError: false

# =============================
# ğŸ“Š ETAPA 3: PUBLICAR RESULTADOS DOS TESTES
# =============================
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    failTaskOnFailedTests: true
  displayName: 'ğŸ“Š Publicar resultados dos testes'

# =============================
# ğŸ“¦ ETAPA 4: PUBLICAR ARTEFATOS
# =============================
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'
  displayName: 'ğŸ“¦ Publicar artefatos de build'

# =============================
# â˜ï¸ ETAPA 5: DEPLOY NO AZURE
# =============================
- task: AzureCLI@2
  displayName: 'ğŸ§± Criar grupo de recursos e App Service (se nÃ£o existir)'
  inputs:
    azureSubscription: 'qmove-azure-connection'  
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az group create --name qmove-rg --location brazilsouth
      az appservice plan create --name qmove-plan --resource-group qmove-rg --sku B1 --is-linux
      az webapp create --name qmove-api --resource-group qmove-rg --plan qmove-plan --runtime "DOTNET|9.0"

- task: AzureWebApp@1
  displayName: 'ğŸš€ Fazer deploy no Azure Web App'
  inputs:
    azureSubscription: 'qmove-azure-connection'   
    appName: 'qmove-api'                   
    package: '$(System.DefaultWorkingDirectory)/**/*.zip'
