# ============================================
# ğŸš€ PIPELINE COMPLETA - MOTO MONITORAMENTO (CI + CD)
# ============================================

trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

stages:
  # ============================================
  # ğŸ§± CI - Build + Testes + Artefatos (dotnet publish)
  # ============================================
  - stage: CI
    displayName: "IntegraÃ§Ã£o ContÃ­nua (Build + Testes)"
    jobs:
      - job: BuildAndTest
        displayName: "Build e Testes AutomÃ¡ticos"
        steps:
          - checkout: self
            displayName: "ğŸ“¦ Checkout do repositÃ³rio"

          - task: UseDotNet@2
            inputs:
              packageType: "sdk"
              version: "9.0.x"
            displayName: "ğŸ”§ Instalar .NET 9 SDK"

          - task: DockerInstaller@0
            displayName: "ğŸ³ Instalar Docker"

          # Restaurar dependÃªncias
          - script: |
              echo "ğŸ“¦ Restaurando dependÃªncias..."
              dotnet restore MotoMonitoramento.sln
            displayName: "ğŸ“¦ Restaurar dependÃªncias"

          # Compilar aplicaÃ§Ã£o
          - script: |
              echo "ğŸ—ï¸ Compilando aplicaÃ§Ã£o..."
              dotnet build MotoMonitoramento.sln --configuration $(buildConfiguration) --no-restore
            displayName: "âš™ï¸ Compilar aplicaÃ§Ã£o"

          # Criar pastas de teste
          - script: |
              mkdir -p tests/MotoMonitoramento.Tests.Unit/TestResults
              mkdir -p tests/MotoMonitoramento.Tests.Integration/TestResults
            displayName: "ğŸ“‚ Preparar diretÃ³rios de testes"

          # Executar testes unitÃ¡rios
          - script: |
              echo "ğŸ§ª Executando testes UnitÃ¡rios..."
              dotnet test tests/MotoMonitoramento.Tests.Unit/MotoMonitoramento.Tests.Unit.csproj \
                --no-build \
                --logger "trx;LogFileName=tests/MotoMonitoramento.Tests.Unit/TestResults/UnitTests.trx"
            displayName: "ğŸ§ª Testes UnitÃ¡rios"

          # Executar testes de integraÃ§Ã£o
          - script: |
              echo "ğŸ§ª Executando testes de IntegraÃ§Ã£o..."
              dotnet test tests/MotoMonitoramento.Tests.Integration/MotoMonitoramento.Tests.Integration.csproj \
                --no-build \
                --logger "trx;LogFileName=tests/MotoMonitoramento.Tests.Integration/TestResults/IntegrationTests.trx"
            displayName: "ğŸ§ª Testes de IntegraÃ§Ã£o"

          # Verificar arquivos TRX (debug)
          - script: |
              echo "ğŸ” ConteÃºdo dos TestResults UnitÃ¡rio:"
              ls -la tests/MotoMonitoramento.Tests.Unit/TestResults
              echo "ğŸ” ConteÃºdo dos TestResults IntegraÃ§Ã£o:"
              ls -la tests/MotoMonitoramento.Tests.Integration/TestResults
            displayName: "ğŸ” Verificar arquivos TRX"

          # Publicar resultados de teste
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: "VSTest"
              testResultsFiles: "tests/**/*.trx"
              failTaskOnFailedTests: true
            displayName: "ğŸ“Š Publicar resultados dos testes"

          # Publicar aplicaÃ§Ã£o para ArtifactStagingDirectory
          - script: |
              echo "ğŸ“‚ Publicando aplicaÃ§Ã£o para ArtifactStagingDirectory..."
              dotnet publish MotoMonitoramento.sln -c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)/App
            displayName: "ğŸ“‚ dotnet publish para artifact"

          # Publicar artefatos
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)"
              ArtifactName: "drop"
              publishLocation: "Container"
            displayName: "ğŸ“¦ Publicar artefatos"

          # Build e push Docker
          - task: AzureCLI@2
            inputs:
              azureSubscription: "qmove-azure-connection"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "ğŸ³ Build e push das imagens para o ACR..."
                chmod +x ./build.sh
                ./build.sh
            displayName: "ğŸ³ Build e push Docker"

  # ============================================
  # â˜ï¸ CD - Deploy automÃ¡tico no Azure
  # ============================================
  - stage: CD
    displayName: "Entrega ContÃ­nua (Deploy no Azure)"
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: "ğŸš€ Executar Deploy no Azure"
        steps:
          - checkout: self
            displayName: "ğŸ“¦ Checkout do repositÃ³rio"

          - task: AzureCLI@2
            inputs:
              azureSubscription: "qmove-azure-connection"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "â˜ï¸ Executando deploy no Azure..."
                chmod +x ./deploy.sh
                ./deploy.sh
            displayName: "â˜ï¸ Deploy via Azure CLI"
